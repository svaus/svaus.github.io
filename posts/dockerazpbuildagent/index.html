<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
<meta http-equiv="x-ua-compatible" content="ie=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

<meta property="og:title" content="Docker azure pipeline build agent" />
<meta property="og:description" content="Creating a docker build agent for azure pipeline is very easy. There are few simple steps. We will be using chocoletey to create this agent.
Firstly create a Dockerfile where we can provide docker instructions. In this case I am using windows core 2019 image, but you can use any other images.
FROMmcr.microsoft.com/windows/servercore:ltsc2019SHELL [&#34;powershell&#34;, &#34;-Command&#34;, &#34;$ErrorActionPreference = &#39;Stop&#39;; $ProgressPreference = &#39;SilentlyContinue&#39;;&#34;]WORKDIR/azpCOPY InstallChoco.ps1 .RUN .\InstallChoco.ps1 COPY InstallDotNetCoreSdkChoco.ps1 .RUN .\InstallDotNetCoreSdkChoco.ps1COPY start.ps1 .CMD powershell ." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://svaus.github.io/posts/dockerazpbuildagent/" />
<meta property="article:published_time" content="2020-05-10T16:08:37+10:00" />
<meta property="article:modified_time" content="2020-05-11T11:48:28+10:00" />

<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Docker azure pipeline build agent"/>
<meta name="twitter:description" content="Creating a docker build agent for azure pipeline is very easy. There are few simple steps. We will be using chocoletey to create this agent.
Firstly create a Dockerfile where we can provide docker instructions. In this case I am using windows core 2019 image, but you can use any other images.
FROMmcr.microsoft.com/windows/servercore:ltsc2019SHELL [&#34;powershell&#34;, &#34;-Command&#34;, &#34;$ErrorActionPreference = &#39;Stop&#39;; $ProgressPreference = &#39;SilentlyContinue&#39;;&#34;]WORKDIR/azpCOPY InstallChoco.ps1 .RUN .\InstallChoco.ps1 COPY InstallDotNetCoreSdkChoco.ps1 .RUN .\InstallDotNetCoreSdkChoco.ps1COPY start.ps1 .CMD powershell ."/>


    <meta name="description" content="">
    <link rel="canonical" href="https://svaus.github.io/posts/dockerazpbuildagent/">

    
    <title>Docker azure pipeline build agent &middot; Go Code</title>

    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/css/materialize.min.css">
    <link href="https://svaus.github.io/css/style.css" rel="stylesheet">

    

    

    
  </head>
  <body>
    
      



<nav class="white" role="navigation">
    <div class="row max-width">
        <div class="col s12 l10 offset-l1">
            
            <a href="#" data-target="nav-mobile" class="sidenav-trigger black-text">
                <i class="material-icons">menu</i>
            </a>

            
            <ul id="nav-mobile" class="sidenav">
                
                
    
    

            </ul>

            
            <a href="/" class="brand-logo grey-text text-darken-3">Go Code</a>

            
            <div class="nav-wrapper">

                
                <ul class="right hide-on-med-and-down">
                    
                    
    
    

                </ul>

            </div>
        </div>
    </div>
</nav>
    

    

<article class="max-width">
    
    <section class="row">
        <div class="col s12 m10 offset-m1 l10 offset-l1">
            <h1>Docker azure pipeline build agent</h1>
        </div>
    </section>

    
    

    
    <section class="row">
        <div class="col s12 m8 offset-m2 l2 offset-l1">
            

<p class="article-meta">
    <div class="article-meta-container">
        <div class="article-meta-author-name"></div>
        <div class="article-meta-description"></div>
    </div>
    <span class="article-meta-published-at grey-text text-darken-1">May 10, 2020</span>
</p>
        </div>
        <div class="col s12 m8 offset-m2 l6">
            <p>Creating a docker build agent for azure pipeline is very easy. There are few simple steps. We will be using chocoletey to create this agent.</p>
<p>Firstly create a Dockerfile where we can provide docker instructions. In this case I am using windows core 2019 image, but you can use any other images.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-Dockerfile" data-lang="Dockerfile"><span style="color:#66d9ef">FROM</span><span style="color:#e6db74"> mcr.microsoft.com/windows/servercore:ltsc2019</span><span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">SHELL</span> [<span style="color:#e6db74">&#34;powershell&#34;</span>, <span style="color:#e6db74">&#34;-Command&#34;</span>, <span style="color:#e6db74">&#34;$ErrorActionPreference = &#39;Stop&#39;; $ProgressPreference = &#39;SilentlyContinue&#39;;&#34;</span>]<span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">WORKDIR</span><span style="color:#e6db74"> /azp</span><span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">COPY</span> InstallChoco.ps1 .<span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">RUN</span> .<span style="color:#ae81ff">\I</span>nstallChoco.ps1 <span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">COPY</span> InstallDotNetCoreSdkChoco.ps1 .<span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">RUN</span> .<span style="color:#ae81ff">\I</span>nstallDotNetCoreSdkChoco.ps1<span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">COPY</span> start.ps1 .<span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">CMD</span> powershell .<span style="color:#ae81ff">\s</span>tart.ps1<span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010">
</span></code></pre></div><ol>
<li>Start from a base image it could be ltsc2019 or ltsc2016 or ubuntu image.</li>
<li>Set Powershll as the shell command</li>
<li>Set WORKDIR - working directory to azp or something of your choice</li>
<li>Copy and run 3 powershell scripts <code>InstallChoco.ps1</code> , <code>InstallDotNetCoreSdkChoco.ps1</code> and <code>start.ps1</code> using the COPY and RUN instruction of Dockerfile</li>
</ol>
<p>Let us add the powershell scripts. Note that you can get latest powershell from microsoft docs <a href="https://docs.microsoft.com/en-us/azure/devops/pipelines/agents/docker?view=azure-devops">https://docs.microsoft.com/en-us/azure/devops/pipelines/agents/docker?view=azure-devops</a>.</p>
<p>Save the below content to <code>start.ps1</code> file:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-Powershell" data-lang="Powershell"><span style="color:#66d9ef">if</span> (<span style="color:#f92672">-not</span> (Test-Path Env<span style="color:#960050;background-color:#1e0010">:</span>AZP_URL)) {
  Write-Error <span style="color:#e6db74">&#34;error: missing AZP_URL environment variable&#34;</span>
  exit 1
}

<span style="color:#66d9ef">if</span> (<span style="color:#f92672">-not</span> (Test-Path Env<span style="color:#960050;background-color:#1e0010">:</span>AZP_TOKEN_FILE)) {
  <span style="color:#66d9ef">if</span> (<span style="color:#f92672">-not</span> (Test-Path Env<span style="color:#960050;background-color:#1e0010">:</span>AZP_TOKEN)) {
    Write-Error <span style="color:#e6db74">&#34;error: missing AZP_TOKEN environment variable&#34;</span>
    exit 1
  }

  $Env:AZP_TOKEN_FILE = <span style="color:#e6db74">&#34;\azp\.token&#34;</span>
  $Env:AZP_TOKEN | Out-File -FilePath $Env:AZP_TOKEN_FILE
}

Remove-Item Env<span style="color:#960050;background-color:#1e0010">:</span>AZP_TOKEN

<span style="color:#66d9ef">if</span> ($Env:AZP_WORK <span style="color:#f92672">-and</span> <span style="color:#f92672">-not</span> (Test-Path Env<span style="color:#960050;background-color:#1e0010">:</span>AZP_WORK)) {
  New-Item $Env:AZP_WORK -ItemType directory | Out-Null
}

New-Item <span style="color:#e6db74">&#34;\azp\agent&#34;</span> -ItemType directory | Out-Null

<span style="color:#75715e"># Let the agent ignore the token env variables</span>
$Env:VSO_AGENT_IGNORE = <span style="color:#e6db74">&#34;AZP_TOKEN,AZP_TOKEN_FILE&#34;</span>

Set-Location agent

Write-Host <span style="color:#e6db74">&#34;1. Determining matching Azure Pipelines agent...&#34;</span> -ForegroundColor Cyan

$base64AuthInfo = <span style="color:#66d9ef">[Convert]</span>::ToBase64String(<span style="color:#66d9ef">[Text.Encoding]</span>::ASCII.GetBytes(<span style="color:#e6db74">&#34;:</span>$(Get-Content ${Env<span style="color:#960050;background-color:#1e0010">:</span>AZP_TOKEN_FILE})<span style="color:#e6db74">&#34;</span>))
$package = Invoke-RestMethod -Headers @{Authorization=(<span style="color:#e6db74">&#34;Basic $base64AuthInfo&#34;</span>)} <span style="color:#e6db74">&#34;</span>$(${Env<span style="color:#960050;background-color:#1e0010">:</span>AZP_URL})<span style="color:#e6db74">/_apis/distributedtask/packages/agent?platform=win-x64&amp;</span><span style="color:#ae81ff">`$</span><span style="color:#e6db74">top=1&#34;</span>
$packageUrl = $package[0].Value.downloadUrl

Write-Host $packageUrl

Write-Host <span style="color:#e6db74">&#34;2. Downloading and installing Azure Pipelines agent...&#34;</span> -ForegroundColor Cyan

$wc = New-Object System.Net.WebClient
$wc.DownloadFile($packageUrl, <span style="color:#e6db74">&#34;</span>$(Get-Location)<span style="color:#e6db74">\agent.zip&#34;</span>)

Expand-Archive -Path <span style="color:#e6db74">&#34;agent.zip&#34;</span> -DestinationPath <span style="color:#e6db74">&#34;\azp\agent&#34;</span>

<span style="color:#66d9ef">try</span>
{
  Write-Host <span style="color:#e6db74">&#34;3. Configuring Azure Pipelines agent...&#34;</span> -ForegroundColor Cyan

  .\config.cmd --unattended `
    --agent <span style="color:#e6db74">&#34;</span>$(<span style="color:#66d9ef">if</span> (Test-Path Env<span style="color:#960050;background-color:#1e0010">:</span>AZP_AGENT_NAME) { ${Env<span style="color:#960050;background-color:#1e0010">:</span>AZP_AGENT_NAME} } <span style="color:#66d9ef">else</span> { ${Env<span style="color:#960050;background-color:#1e0010">:</span>computername} })<span style="color:#e6db74">&#34;</span> `
    --url <span style="color:#e6db74">&#34;</span>$(${Env<span style="color:#960050;background-color:#1e0010">:</span>AZP_URL})<span style="color:#e6db74">&#34;</span> `
    --auth PAT `
    --token <span style="color:#e6db74">&#34;</span>$(Get-Content ${Env<span style="color:#960050;background-color:#1e0010">:</span>AZP_TOKEN_FILE})<span style="color:#e6db74">&#34;</span> `
    --pool <span style="color:#e6db74">&#34;</span>$(<span style="color:#66d9ef">if</span> (Test-Path Env<span style="color:#960050;background-color:#1e0010">:</span>AZP_POOL) { ${Env<span style="color:#960050;background-color:#1e0010">:</span>AZP_POOL} } <span style="color:#66d9ef">else</span> { <span style="color:#e6db74">&#39;Default&#39;</span> })<span style="color:#e6db74">&#34;</span> `
    --work <span style="color:#e6db74">&#34;</span>$(<span style="color:#66d9ef">if</span> (Test-Path Env<span style="color:#960050;background-color:#1e0010">:</span>AZP_WORK) { ${Env<span style="color:#960050;background-color:#1e0010">:</span>AZP_WORK} } <span style="color:#66d9ef">else</span> { <span style="color:#e6db74">&#39;_work&#39;</span> })<span style="color:#e6db74">&#34;</span> `
    -<span style="color:#f92672">-replace</span>

  <span style="color:#75715e"># remove the administrative token before accepting work</span>
  Remove-Item $Env:AZP_TOKEN_FILE

  Write-Host <span style="color:#e6db74">&#34;4. Running Azure Pipelines agent...&#34;</span> -ForegroundColor Cyan

  .\run.cmd
}
<span style="color:#66d9ef">finally</span>
{
  Write-Host <span style="color:#e6db74">&#34;Cleanup. Removing Azure Pipelines agent...&#34;</span> -ForegroundColor Cyan

  .\config.cmd remove --unattended `
    --auth PAT `
    --token <span style="color:#e6db74">&#34;</span>$(Get-Content ${Env<span style="color:#960050;background-color:#1e0010">:</span>AZP_TOKEN_FILE})<span style="color:#e6db74">&#34;</span>
}
</code></pre></div><p>Create a new file named <code>InstallChoco.ps1</code>. This will be used to install choco in the docker images</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-Powershell" data-lang="Powershell">

<span style="color:#66d9ef">[Net.ServicePointManager]</span>::SecurityProtocol = <span style="color:#66d9ef">[Net.ServicePointManager]</span>::SecurityProtocol <span style="color:#f92672">-bor</span> <span style="color:#e6db74">&#34;Tls12&#34;</span>

Invoke-WebRequest -Uri <span style="color:#e6db74">&#34;https://chocolatey.org/install.ps1&#34;</span> -Outfile <span style="color:#e6db74">&#34;chocoinstall.ps1&#34;</span>

.\chocoinstall.ps1

choco config set cachelocation C:\chococache

</code></pre></div><p>Once choco is added, you can add any capability by simply installing it with choco. So let us add dotnet core sdk via choco. Create a file named <code>InstallDotNetCoreSdkChoco.ps1</code> and add below code.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-Powershell" data-lang="Powershell">choco install dotnetcore-sdk -version 2.1.4 --confirm --limit-output 
choco install dotnetcore-sdk -version 2.1.7 --confirm --limit-output 
choco install dotnetcore-sdk -version 3.1.0 --confirm --limit-output 

</code></pre></div><h1 id="creating-docker-container-for-azp">Creating docker container for azp</h1>
<p>Build the docker images using docker build command.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-Powershell" data-lang="Powershell">docker build -t myazpagent<span style="color:#960050;background-color:#1e0010">:</span>latest .
</code></pre></div><p>Once this is done, you can easily create the docker container by running below command.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-Powershell" data-lang="Powershell">docker run -e AZP_URL=https<span style="color:#960050;background-color:#1e0010">:</span>//dev.azure.com/{username} -e AZP_TOKEN=$Env:AZP_TOKEN -e AZP_AGENT_NAME=$Env:AZP_Build_Agent_Name -e AZP_POOL=$Env:AZP_POOL myazpagent<span style="color:#960050;background-color:#1e0010">:</span>latest

</code></pre></div><p>Have fun !!</p>

        </div>
    </section>
</article>



    
      <footer class="page-footer grey lighten-5">
    <div class="row max-width">
        <div class="col s12 l10 offset-l1 clear-padding">
            <div class="row">
    
        
    

    
    
    <div class="col s12 l12">
        <h5 class="black-text">Have fun with coding</h5>
<p class="grey-text text-darken-4">Look for posts on dotnet, azure, devops blogs.</p>
    </div>

    
</div>


        </div>
    </div>
    <div class="footer-copyright">
        <div class="row max-width" style="width: 100%;">
            <div class="col s12 l10 offset-l1">
                <span class="grey-text text-darken-4">© 2020.</span>
<div class="right">
    
</div>
            </div>
        </div>
    </div>
</footer>
    

    
    <script src="https://code.jquery.com/jquery-3.2.1.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/js/materialize.min.js"></script>
    <script src="https://svaus.github.io/js/script.js"></script>
  </body>
</html>